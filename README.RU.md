## Контракты периодического розыгрыша вознаграждений на депозитных пулах в фермах

Полный код и документация контрактов на периодические розыгрыши вознаграждений на депозит из пулов в фермах Crunchy или Qupipuswap.
Проект разработан на Debian 11, не тестировался на других ОС.

## Начало работы

### Установка инструментов

Выполнить скрипт `./install/install_all.sh` для скачивания и установки: LIGO, tezos-client, python, pytezos и т.д.
Или выполните скрипты ./install/install_*.sh для каждого инструмента вручную.

### Компилирование

Использование: compile.sh NAME|ALL
Скомпилируйте 'contracts/NAME.ligo' или 'contracts/*.ligo' для ALL.
Скомпилированные файлы сохраняются в файлах build/NAME.tz и build/NAME.storage.tz.

### Тестирование

Использование: tests.sh NAME|ALL
Исполняет тесты из 'tests/NAME.ligo' или 'tests/*.ligo' для ALL.
Логи тестирования сохраняются в файлах build/NAME.test.log.

### Развертывание

Использование: deploy.sh NAME|ALL [force]
Развертывание 'build/NAME.tz', инициализированное «build/NAME.storage.tz» (или «build/*.tz» для ALL), с помощью учетной записи, сохраненной как owner в tezos-client.

### Документация

Во-первых, установите подмодули с помощью `git submodule update --init --recursive`.
Затем выполните скрипт `./doc/doc.sh`, чтобы сгенерировать английскую и русскую документацию к контрактам.
Код использует скрипты подпроектов, прикрепленных как подмодули git:
- https://github.com/dimdim1177/mlcomment Многоязычные комментарии
- https://github.com/dimdim1177/ligo2dox Преобразование PascaLIGO в как бы C++ код для автоматического документирования с помощью Doxygen

## Контракты

### Контракт с пулами

См. Contracts/CPoolGames.ligo и папку Contracts/CPoolGames.
Основные характеристики:
- Поддержка 2 интерфейсов ферм: Crunchy и QUIPU
- Три алгоритма определения победителя:
    - Вероятность выигрыша пропорциональна времени в текущей игре
    - Вероятность выигрыша пропорциональна сумме времени * депозита в текущей игре
    - Равные вероятности для всех пользователей в пуле
- Дополнительные опции пула:
    - минимальный депозит
    - минимальные секунды в игре
    - максимальный депозит (только для алгоритма по сумме время * депозит)
    - процент выигрыша, процент сжигания, процент вознаграждения
    - токен для сжигания, адрес комиссии
- Гибкое конфигурирование:
    - владельцы/администраторы пула или пул-как-услуга
    - можно включить безопасную перечисление токенов (удалить оператора после перечисления)
    - можно включить статистику пула в блокчейне для продвижения
    - можно включить views пула для других смарт-контрактов

### Контракт для генерации случайных чисел

См. Contracts/CRandom.ligo и папку Contracts/CRandom.
Основные характеристики:
- Любой может запросить случайное число в будущем
- Запрос содержит адрес и идентификатор объекта
- Случайное число основано на хеше ближайшего блока Tezos с бОльшим временем запроса и XOR с хэшем запроса, поэтому один блок Tezos генерирует разные случайные числа для разных запросов.


## Дерево папок

### contracts

Папка с кодом контрактов. Файлы по маске contracts/CONTRACT_NAME.ligo скомпилированы как контракты.
Папка contracts/CONTRACT_NAME, используемая для конкретных контрактов и модулей.
Файл contracts/CONTRACT_NAME/config.ligo содержит определения конфигурации контракта.
Файл contracts/CONTRACT_NAME/initial_storage.ligo содержит описание начального хранилища.

#### contracts/include

Общие include для всех контрактов.

#### contracts/module

Общие модули для всех контрактов.

#### contracts/CPoolGames

Include и модули для контракта contracts/CPoolGames.ligo.

#### contracts/CRandom

Include и модули для контракта contracts/CRandom.ligo.

### doc

Папка с документацией.
Файл algo.xlsx - сравнительная таблица изменения весов пользователей и партии в различных алгоритмах в различных ситуациях для упрощения понимания логики начисления весов.

#### html-ru

Документация на английском языке, пожалуйста, откройте doc/html-en/index.html

#### html-ru

Русскоязычная документация, пожалуйста, откройте doc/html-ru/index.html

#### doc/ligo2dox

https://github.com/dimdim1177/mlcomment Многоязычные комментарии

#### doc/ligo2dox

https://github.com/dimdim1177/ligo2dox Преобразование PascaLIGO в C++ как код для автоматического документирования с помощью Doxygen

### accounts

Папка с файлами аккаунтов *.json, загруженными с https://teztnets.xyz/, базовое имя файла используется как имя учетной записи в tezos-client.
Один из них должен называться owner.json, эта учетная запись используется для развертывания контрактов.
Скрипт `accounts/activate.sh` активирует все учетные записи в тестовой сети.

### build

Папка для скомпилированных файлов *.tz, логов *.log и т.д.

### install

Папка со скриптами для установки средств разработки: LIGO, tezos-client и так далее.

### tests

Тесты на LIGO. См. файлы `tests/CPoolGames.ligo` и `tests/CRandom.ligo`.

#### tests/include

Общий код тестирования.

#### tests/CPoolGames

Код тестирования только для CPoolGames.

#### tests/CRandom

Код тестирования только для CRandom.

### tezbin

Бинарники от tezos: tezos-client и так далее.

### venv

Виртуальная среда для python
